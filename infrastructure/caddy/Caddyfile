api.glamyouup.tech {
    # CORS - Allow all your environments
    @cors_preflight method OPTIONS

    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin "{header.Origin}"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Authorization, Content-Type, X-Shop-Domain"
            Access-Control-Allow-Credentials "true"
        }
        respond 204
    }

    # Allowed origins check
    @allowed_origins {
        header Origin https://glamyouup.tech
        header Origin https://www.glamyouup.tech
        header Origin https://glam-shopify-app.vercel.app
        header Origin https://glam-shopify-app-preview.vercel.app
        header Origin http://localhost:3000
    }

    handle @allowed_origins {
        header {
            Access-Control-Allow-Origin "{header.Origin}"
            Access-Control-Allow-Credentials "true"
        }
    }

    # Service routes
    handle /api/v1/merchants* {
        reverse_proxy merchant-service:8013
    }

    handle /api/v1/catalog* {
        reverse_proxy catalog-service:8014
    }

    handle /api/v1/credits* {
        reverse_proxy credit-service:8015
    }

    handle /api/v1/billing* {
        reverse_proxy billing-service:8016
    }

    handle /api/v1/analytics* {
        reverse_proxy analytics-service:8017
    }

    handle /api/v1/webhooks* {
        reverse_proxy webhook-service:8012
    }

    handle /api/v1/tokens* {
        reverse_proxy token-service:8007
    }

    handle /api/v1/selfie* {
        reverse_proxy selfie-service:8026
    }

    handle /api/v1/recommendations* {
        reverse_proxy recommendation-service:8025
    }

    handle /api/v1/notifications* {
        reverse_proxy notification-service:8008
    }

    handle /health {
        respond `{"status": "healthy"}` 200
    }
}
